
<template>
  <div class="page" data-name="friend">
    <div class="appbar">
      <div class="appbar-inner">
        FriendFinder
      </div>
    </div>
    <div class="page-content">
      <div class="block-title">
        {{#if friend._id}}
          Répondre à une demande ou modifier une amitiée
        {{else}}
          Ajouter un ami
        {{/if}}
      </div>
      <form class="list" id="friend-form">
        <ul>
        {{#if friend._id}}
          <li>
            <div class="item-content item-input">
              <div class="item-inner">
                <div class="item-title item-label">Voulez vous être amis avec {{friend.mailSender}} (0 = non ; 1 = oui)</div>
                <div class="item-input-wrap">
                  <input id="input-acceptation" type="text" name="acceptation" placeholder="acceptation" value="{{friend.acceptation}}">
                </div>
              </div>
            </div>
          </li>
        {{else}}
          <li>
            <div class="item-content item-input">
              <div class="item-inner">
                <div class="item-title item-label">Mail de la personne</div>
                <div class="item-input-wrap">
                  <input id="input-mailReceiver" type="text" name="mailReceiver" placeholder="mail" value="">
                </div>
              </div>
            </div>
          </li>
        {{/if}}

        </ul>
      </form>
      <div class="block block-strong row">
        <div class="col"><a @click="cancel" class="button" href="#">Cancel</a></div>
        {{#if friend._id}}<div class="col"><a @click="delete" class="button" href="#">Delete</a></div>{{/if}}
        <div class="col"><a @click="save" class="button" href="#">Save</a></div>
      </div>
    </div>
  </div>
</template>
<script>
  return {
    async data() {
      let friend = {};
      var USER = "j22.dubreuil@gmail.com";
      var mailSender = undefined;
      var mailReceiver = undefined;
      var acceptation = undefined;
      
      mailSender = this.$route.params.mailSender;
      mailReceiver = this.$route.params.mailReceiver;

      if ((mailSender != undefined) || (mailReceiver != undefined)) {
        if (mailSender == undefined){
            mailSender = USER;
        }
        else {
          mailReceiver = USER;
        }

        try {
          friend = await fetch("http://localhost:3000/friendRequest/" + mailSender + "/" + mailReceiver).then(res => res.json());
          console.log(friend);
        } catch(err) {
          this.$app.dialog.alert("Error " + err);
        }
      }
      return {
        friend: friend
      }
    },

    methods: {
      cancel: function() {
        this.$router.back();
      },

      save: function() {
        var USER = "j22.dubreuil@gmail.com";
        if (mailSender != undefined) {
          mailSender = USER;
          mailReceiver = document.querySelector('#input-mailReceiver').value;
          acceptation = "0";
        }
        else {
          const acceptation = document.querySelector('#input-acceptation').value;
        }
        const queryData = this.getSaveQueryData();

        fetch(queryData.url, {
          method: queryData.method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mailSender: mailSender,
            mailReceiver: mailReceiver,
            acceptation: acceptation
          })
        })
          .catch(err => this.$app.dialog.alert('Error ' + err))
          .finally(() => {
            this.$router.navigate("/");
          });
      },

      getSaveQueryData: function() {
        if (this.friend._id != undefined) {
          return {
            url: "http://localhost:3000/friendRequest/" + this.friend._id,
            method: "PUT"
          }
        } else {
          return {
            url: "http://localhost:3000/friendRequest/",
            method: "POST"
          }
        }
      },

      delete: function() {
        if (this.friend._id != undefined) {
          fetch("http://localhost:3000/friendRequest/" + this.friend._id, {
            method: "DELETE",
          })
            .catch(err => this.$app.dialog.alert('Error ' + err))
            .finally(() => {
              this.$router.navigate("/");
            });
        }
      }
    }
  }
</script>